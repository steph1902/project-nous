// Prisma Schema for AgentOps
// PostgreSQL with pgvector extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ===========================================
// Identity & Access Management
// ===========================================

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  createdAt   DateTime  @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  memberships OrgMember[]
  apiKeys     ApiKey[]
  workflows   Workflow[]
  runs        Run[]
  auditEvents AuditEvent[]

  @@map("users")
}

model Org {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  members      OrgMember[]
  workflows    Workflow[]
  runs         Run[]
  integrations Integration[]
  secrets      Secret[]
  kbDocuments  KbDocument[]
  hrCandidates HrCandidate[]
  auditEvents  AuditEvent[]
  apiKeys      ApiKey[]

  @@map("orgs")
}

model OrgMember {
  orgId     String   @map("org_id")
  userId    String   @map("user_id")
  role      String   // OWNER, ADMIN, OPERATOR, VIEWER
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  org     Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKeys ApiKey[]

  @@id([orgId, userId])
  @@map("org_members")
}

model ApiKey {
  id         String    @id @default(uuid())
  orgId      String    @map("org_id")
  userId     String    @map("user_id")
  name       String
  keyHash    String    @unique @map("key_hash")
  keyPrefix  String    @map("key_prefix")
  scopes     Json      @default("[]")
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgMember OrgMember @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@map("api_keys")
}

// ===========================================
// Workflow Catalog
// ===========================================

model Workflow {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  name        String
  description String?
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  org      Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  creator  User              @relation(fields: [createdBy], references: [id])
  versions WorkflowVersion[]

  @@map("workflows")
}

model WorkflowVersion {
  id         String   @id @default(uuid())
  workflowId String   @map("workflow_id")
  version    Int
  status     String   // DRAFT, PUBLISHED, ARCHIVED
  dagJson    Json     @map("dag_json")
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  workflow Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  triggers WorkflowTrigger[]
  runs     Run[]

  @@unique([workflowId, version])
  @@map("workflow_versions")
}

model WorkflowTrigger {
  id                String   @id @default(uuid())
  workflowVersionId String   @map("workflow_version_id")
  type              String   // MANUAL, WEBHOOK, SCHEDULE
  configJson        Json     @default("{}") @map("config_json")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  workflowVersion WorkflowVersion @relation(fields: [workflowVersionId], references: [id], onDelete: Cascade)

  @@map("workflow_triggers")
}

// ===========================================
// Run Orchestration
// ===========================================

model Run {
  id                String    @id @default(uuid())
  orgId             String    @map("org_id")
  workflowVersionId String    @map("workflow_version_id")
  status            String    // QUEUED, RUNNING, SUCCEEDED, FAILED, CANCELED
  initiatedBy       String    @map("initiated_by")
  inputJson         Json      @default("{}") @map("input_json")
  outputJson        Json?     @map("output_json")
  startedAt         DateTime  @default(now()) @map("started_at")
  finishedAt        DateTime? @map("finished_at")

  // Relations
  org             Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  workflowVersion WorkflowVersion @relation(fields: [workflowVersionId], references: [id])
  initiator       User            @relation(fields: [initiatedBy], references: [id])
  nodes           RunNode[]
  artifacts       Artifact[]

  @@map("runs")
}

model RunNode {
  id         String    @id @default(uuid())
  runId      String    @map("run_id")
  nodeKey    String    @map("node_key")
  type       String
  status     String    // QUEUED, RUNNING, SUCCEEDED, FAILED, SKIPPED
  attempts   Int       @default(0)
  inputJson  Json?     @map("input_json")
  outputJson Json?     @map("output_json")
  errorJson  Json?     @map("error_json")
  startedAt  DateTime? @map("started_at")
  finishedAt DateTime? @map("finished_at")

  // Relations
  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, nodeKey])
  @@map("run_nodes")
}

model Artifact {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  runId        String   @map("run_id")
  kind         String   // OUTPUT, LOG, DOCUMENT
  s3Key        String   @map("s3_key")
  metadataJson Json     @default("{}") @map("metadata_json")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("artifacts")
}

// ===========================================
// Tool Integrations
// ===========================================

model Integration {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  type        String   // SLACK, GMAIL, SHEETS, HTTP
  displayName String   @map("display_name")
  configJson  Json     @default("{}") @map("config_json")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  org         Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  permissions ToolPermission[]

  @@map("integrations")
}

model Secret {
  id             String    @id @default(uuid())
  orgId          String    @map("org_id")
  key            String
  encryptedValue String    @map("encrypted_value")
  createdAt      DateTime  @default(now()) @map("created_at")
  rotatedAt      DateTime? @map("rotated_at")

  // Relations
  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key])
  @@map("secrets")
}

model ToolPermission {
  id            String   @id @default(uuid())
  orgId         String   @map("org_id")
  integrationId String   @map("integration_id")
  principalType String   @map("principal_type") // USER, ROLE, WORKFLOW
  principalId   String   @map("principal_id")
  scopesJson    Json     @default("[]") @map("scopes_json")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("tool_permissions")
}

// ===========================================
// Knowledge Base (RAG)
// ===========================================

model KbDocument {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  title       String
  sourceType  String   @map("source_type") // PDF, MARKDOWN, HTML, TEXT
  s3Key       String   @map("s3_key")
  tagsJson    Json     @default("[]") @map("tags_json")
  accessLevel String   @default("ORG") @map("access_level")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  org    Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  chunks KbChunk[]

  @@map("kb_documents")
}

model KbChunk {
  id           String                       @id @default(uuid())
  documentId   String                       @map("document_id")
  chunkIndex   Int                          @map("chunk_index")
  contentText  String                       @map("content_text")
  tokenCount   Int                          @map("token_count")
  embedding    Unsupported("vector(1536)")?
  metadataJson Json                         @default("{}") @map("metadata_json")

  // Relations
  document KbDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("kb_chunks")
}

// ===========================================
// HR Scoring
// ===========================================

model HrCandidate {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  emailHash String   @map("email_hash")
  metaJson  Json     @default("{}") @map("meta_json")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  org         Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  submissions HrSubmission[]

  @@map("hr_candidates")
}

model HrSubmission {
  id          String   @id @default(uuid())
  candidateId String   @map("candidate_id")
  formVersion String   @map("form_version")
  answersJson Json     @map("answers_json")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  candidate HrCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  scores    HrScore[]

  @@map("hr_submissions")
}

model HrScore {
  id            String   @id @default(uuid())
  submissionId  String   @map("submission_id")
  rubricVersion String   @map("rubric_version")
  modelId       String   @map("model_id")
  scoreJson     Json     @map("score_json")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  submission HrSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("hr_scores")
}

// ===========================================
// Prompt Templates
// ===========================================

model PromptTemplate {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  versions PromptTemplateVersion[]

  @@unique([orgId, name])
  @@map("prompt_templates")
}

model PromptTemplateVersion {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  version    Int
  content    String
  schemaJson Json     @default("{}") @map("schema_json")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  template PromptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@map("prompt_template_versions")
}

// ===========================================
// Audit & Compliance
// ===========================================

model AuditEvent {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  actorType   String   @map("actor_type") // USER, API_KEY, SYSTEM
  actorId     String   @map("actor_id")
  eventType   String   @map("event_type")
  payloadJson Json     @default("{}") @map("payload_json")
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  org  Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [actorId], references: [id])

  @@index([orgId, eventType])
  @@index([orgId, createdAt])
  @@map("audit_events")
}

// ===========================================
// Infrastructure
// ===========================================

model IdempotencyKey {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  key          String
  requestHash  String   @map("request_hash")
  responseJson Json     @map("response_json")
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([orgId, key])
  @@map("idempotency_keys")
}
